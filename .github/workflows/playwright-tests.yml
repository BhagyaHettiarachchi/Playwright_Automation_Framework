name: Playwright AI Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run tests every day at 9 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:  # Allows manual trigger

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium

    - name: Create required directories
      run: |
        mkdir -p data/selectors
        mkdir -p screenshots/baseline
        mkdir -p screenshots/diff
        mkdir -p reports
        mkdir -p tests/generated
        mkdir -p examples/user-stories

    - name: Run Playwright tests
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENAI_MODEL: gpt-4o-mini
        HEADLESS: true
        SELF_HEALING_ENABLED: true
        VISUAL_REGRESSION_ENABLED: true
        BASE_URL: https://demo.playwright.dev/todomvc
      run: npm test
      continue-on-error: true

    - name: Upload Playwright Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: reports/html/
        retention-days: 30

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: test-results/
        retention-days: 30

    - name: Upload screenshots
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: screenshots
        path: screenshots/
        retention-days: 30

    - name: Upload healing log
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: healing-log
        path: data/selectors/healing-log.json
        retention-days: 30

    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const fs = require('fs');
          let comment = '## ğŸ­ Playwright Test Results\n\n';
          
          try {
            const results = JSON.parse(fs.readFileSync('reports/results.json', 'utf8'));
            const passed = results.suites.reduce((acc, suite) => 
              acc + suite.specs.filter(s => s.ok).length, 0);
            const failed = results.suites.reduce((acc, suite) => 
              acc + suite.specs.filter(s => !s.ok).length, 0);
            
            comment += `âœ… Passed: ${passed}\n`;
            comment += `âŒ Failed: ${failed}\n\n`;
            comment += `ğŸ“Š [View Full Report](https://github.com/${{github.repository}}/actions/runs/${{github.run_id}})\n`;
          } catch (error) {
            comment += 'âš ï¸ Could not parse test results\n';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });